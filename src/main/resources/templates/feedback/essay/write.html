<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<th:block th:replace="~{/layout/basic :: setContent(~{this :: content})}">
    <th:block th:fragment="content">
        <head>
            <meta charset="UTF-8">
            <title>essay_write_page</title>

            <style>
                .container-fluid {
                    padding-left: 7%;
                    padding-right: 7%;
                }

                textarea {
                    resize: none;
                }

                textarea::selection {
                    background-color: pink;
                }
            </style>

        </head>
        <body>
        <form class="container-fluid" action method="post" th:object="${feedback}">
            <label class="form-control text-center mt-3" th:text="|${feedback.essayPostName} 게시물을 첨삭하고 있습니다.|"></label><br>
            <button type="button" onclick="showGuide()">첨삭 방법</button>
            <div th:each="idx : ${#numbers.sequence(0,feedback.getQuestions().size()-1)}">
                <label th:for="|answer${idx+1}|" th:text="|${idx+1}. ${feedback.questions[idx]}|"></label>
                <textarea type="text" th:id="|answer${idx+1}|" class="form-control" th:text="${feedback.answers[idx]}"
                          th:onselect="|dragUpdate(${idx+1})|" rows=10 disabled></textarea><br>
                <div th:id="|start${idx+1}|"></div>
                <div th:id="|length${idx+1}|"></div>
                <div th:id="|comment${idx+1}|"></div>

                <div th:id="|display${idx+1}|"></div>
                <textarea th:id="|input${idx+1}|" type="text" class="form-control" placeholder="첨삭을 입력하세요" rows=3 th:onchange="|updateBuf(${idx+1})|"></textarea><br>
                <button type="button" th:onclick="|dragCheck(${idx+1})|">첨삭 추가</button>
                <br><br>
            </div>
            <label for="totalComment">총평</label>
            <textarea type="text" id="totalComment" name="comment" class="form-control" rows=3
                      placeholder="총평을 입력해주세요." required></textarea>
            <button type="submit" class="margin-bottom-10 w-300 btn btn-primary">확인</button>
            <br>
        </form>

        <script type="text/javascript">
            let curField, curStart, curLength, curQuestion, startCur = 0, lengthCur = 0, commentCur = 0;
            let isSelected = false;
            let start = [], length = [], comment = [];
            const selectedObj = window.getSelection();
            let commentBuf = new Array([[${feedback.getQuestions().size()}]]);

            function showGuide() {
                alert('1. 문제별로 할당된 첨삭란에 첨삭을 입력합니다.\n' +
                    '2. 첨삭을 입력하고 첨삭 대상 문장을 드래그하세요.\n' +
                    '3. 드래그 후에 첨삭 추가 버튼을 누르면 첨삭이 저장됩니다.\n' +
                    '4. 첨삭 삭제를 누르면 작성한 첨삭이 경고 없이 삭제됩니다.\n' +
                    '5. 총평을 입력하고 저장 버튼을 눌러서 첨삭을 종료하세요.');
            }

            function dragUpdate(idx) { //현재 드래그 결과를 업데이트
                console.log(idx, '번 문제 drag!!!!!!!!!!!!!!!!!!!!!!');
                curField = document.getElementById("answer" + idx);
                curStart = curField.selectionStart;
                curLength = curField.selectionEnd - curField.selectionStart;
                curQuestion = idx;
                isSelected = true; //드래그 여부 저장 (selectedObj.type 으로 체크도 가능하지만 답변 문장만 드래그 위해 사용)
            }

            function dragCheck(idx) { //첨삭하기 버튼을 눌렀을때 처리
                if (selectedObj.type == "Caret") { //드래그 상태가 아닌 경우 취소
                    isSelected = false;
                }
                if (isSelected) { //선택 되었는지
                    if (idx == curQuestion) {
                        console.log('여기서 위치 겹치는지 체크~~~');
                        if (1) {
                            addFeedback(idx);
                        }
                    } else {
                        alert('현재 문항의 문장이 아닙니다.');
                    }
                } else {
                    alert('답변 문장이 선택되지 않았습니다.');
                }
                selectedObj.removeAllRanges(); //모든 레인지 삭제
                isSelected = false;
            }

            function updateBuf(idx) {
                commentBuf[idx-1] = document.getElementById('input' + idx).value;
                console.log("============================================");
                commentBuf.forEach(data => console.log(data));
                console.log(commentBuf);
                console.log("============================================");
            }
            function addFeedback(idx) {
                //문제별 첨삭 리스트에 드래그 결과 추가
                start.push(curStart);
                length.push(curLength);
                comment.push(commentBuf[idx-1]);
                document.getElementById('input' + idx).value = '';

                //해당 innerHtml += (인덱스 정보 + 피드백 내용)
                document.getElementById('start' + idx).innerHTML += '<input type="hidden" name="feedback.commentList[idx-1].start" value='+start[startCur++]+'>';
                document.getElementById('length' + idx).innerHTML += '<input type="hidden" name="feedback.commentList[idx-1].length" value='+length[lengthCur++]+'>';
                document.getElementById('comment' + idx).innerHTML += '<textarea name="feedback.commentList[idx-1].comment" rows="3" readonly>'+comment[commentCur++]+'</textarea><br>';
            }

            function deleteFeedback(idx) {
                //
            }
        </script>
        </body>
    </th:block>
</th:block>