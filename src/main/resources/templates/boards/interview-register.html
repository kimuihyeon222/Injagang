<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<th:block th:replace="~{/layout/basic :: setContent(~{this :: content})}">
    <th:block th:fragment="content">
        <head>
            <style>
                .filebox input[type="file"] {
                    position: absolute;
                    width: 0;
                    height: 0;
                    padding: 0;
                    overflow: hidden;
                    border: 0;
                }
            </style>
        </head>
        <h2 class="mt-3">면접 게시판 글쓰기</h2>
        <hr>
        <form id="addT" name="addT" th:action="@{/interview/board/add}" th:method="post">
            <!-- 게시물 제목 입력 -->
            <div class="form-group">
                <label>제목</label>
                <input id="title" type="text" class="form-control" name="title" placeholder="제목을 입력하세요.">
            </div>
            <br>
    
            <!-- 게시물 내용 글 입력 -->
            <div class="form-group mt-1">
                <label>내용</label>
                <textarea id="content" style="resize: none" class="form-control" rows="8" name="text" placeholder="내용을 입력하세요."></textarea>
            </div>
            <br>
            <!-- 면접 영상 업로드하기 -->
            <br>

            <label>면접 영상 선택</label>
            <hr>
            <div class="uploadResult"></div>
            <div id="videoUrls"></div>

            <div class="form-inline">
                <label class="form-control mr-1 text-center btn btn-outline-info" for="file">파일찾기</label>
                <input class="upload-name form-control col-md" style="pointer-events: none; color: gray" value="첨부파일" placeholder="첨부파일">
                <input type="file" id="file" style="display: none" name="uploadFiles" multiple>
                <button class="uploadBtn form-control btn-outline-info ml-1" type="button">업로드</button>
            </div>
            <br>
<!--            <label class="btn btn-outline-info" for="input-file">파일 선택</label>-->
<!--            <input id="input-file" name="uploadFiles" style="display: none" type="file" multiple>-->
<!--            <button type="button" class="uploadBtn form-control btn-outline-info mt-1">업로드</button>-->
<!--            <br>-->
            <br>
            <input id="save" type="button" class="btn btn-outline-info form-control" value="게시물 저장">
            <br>
            <br>
        </form>
        
        <script th:inline="javascript">
            let urls = [];
            let selectedVideos = [];
            let selected = "empty";
            //업로드한 비디오 보여주기
            function showUploadedVideos(arr){
                console.log(arr);
                $(".upload-name").val("파일선택");

                let divArea = $('.uploadResult');
                for (let i = 0; i < arr.length; i++) {
                    let title = arr[i].fileName.split('_')[0];
                    selectedVideos.push(title);
                    divArea.append("<div class='text-center'><label class='text-center' style='margin: 0'><"+title+"></label><br><video width='75%;' controls><source src='/display?fileName="+arr[i].videoURL+"'></video></div><br>");
                    urls.push(arr[i].videoURL);
                }
                
                document.getElementById('videoUrls').innerHTML =
                        '<input name="videoUrls" value='+urls+' style="display: none">';
            }
            
            $('.uploadBtn').click(function () {
                let formData = new FormData();
                let inputFile = $("input[type='file']");
                let files = inputFile[0].files;
                for (let i = 0; i < files.length; i++) {
                    formData.append("uploadFiles", files[i]);
                }
    
                //실제 업로드 부분
                //upload ajax
                $.ajax({
                    url: '/uploadAjax',
                    processData: false,
                    contentType: false,
                    data: formData,
                    type: 'POST',
                    dataType: 'json',
                    success: function (result){
                        if (selected == "empty") {
                            alert("파일이 선택되지 않았습니다.");
                        }
                        else {
                            showUploadedVideos(result);
                            selected = "empty";
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        alert("파일이 선택되지 않았습니다.");
                        console.log(textStatus);
                    }
                });
            });

            // 파일 선택시 파일 이름으로 변경
            $("#file").on('change',function(){
                let inputFile = $("input[type='file']");
                let files = inputFile[0].files;
                if (files.length != 0) {
                    if (files.length == 1) {
                        selected = $("#file").val();
                        $(".upload-name").val($("#file").val());
                    } else {
                        selected = $("#file").val() + "...외 " + (files.length - 1) + "개";
                        $(".upload-name").val(selected);
                    }
                }
            });
!!!!씨발 여기 비디오 처리하는거 고쳐야함
            //게시물 저장 버튼 클릭시
            $("#save").click(function () {
                //안에 내용이 다 적혀있는지
                if (document.getElementById("title").value.length == 0) {
                    alert("제목이 입력되지 않았습니다.");
                }
                else if (document.getElementById("content").value.length == 0) {
                    alert("내용이 입력되지 않았습니다.");
                }
                else if (urls.length == 0) {
                    alert("면접 영상을 선택해주세요.");
                }
                else {
                    alert("게시물이 저장되었습니다.");
                    document.getElementById("addT").submit();
                }
            });
        </script>
        
    </th:block>
</th:block>