<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<th:block th:replace="~{/layout/basic :: setContent(~{this :: content})}">
    <th:block th:fragment="content">
        <h2 class="mt-4">면접 게시판 글쓰기</h2>
    
        <form th:action="@{/interview/board/add}" th:method="post">
            <!-- 게시물 제목 입력 -->
            <div class="form-group">
                <label> 제목</label>
                <input type="text" class="form-control" name="title" placeholder="제목을 입력하세요">
            </div>
            <br>
    
            <!-- 게시물 내용 글 입력 -->
            <div class="form-group">
                <label>Content</label>
                <textarea class="form-control" rows="8" name="text"></textarea>
            </div>
            
            <!-- 면접 영상 업로드하기 -->
            <div class="form-group">
                <label><b>면접 영상 업로드</b></label>
                <input name="uploadFiles" type="file" onchange="uploadVideos()" multiple>
            </div>
            
            <div class="uploadResult"></div>
            <div id="videoUrls"></div>
            
            <br>
            <button type="submit" class="btn btn-primary registerInterview" style="float: right" onclick="pushVideoURLs()">
                게시물 저장
            </button>
        </form>
        
        <script th:inline="javascript">
            let urls = []; //영상들의 저장 경로
            //업로드한 비디오 보여주기
            function showUploadedVideos(arr){
                console.log(arr);
                let divArea = $('.uploadResult');
    
                let str = ""
                for (let i = 0; i < arr.length; i++) {
                    str += "<div>";
                    str += '<label>영상 제목</label>&nbsp';
                    str += '<input name="videoNames"><br>'; //영상 제목 입력란
                    str += "<video width='640' height='auto'controls><source src='/display?fileName="+arr[i].videoURL+"'></video>";
                    str += "<input class='btn btn-outline-info removeBtn' type='button' data-name='"+arr[i].videoURL+"' value='X'>";
                    str += "</div>";
                    urls.push(arr[i].videoURL);
                }
                divArea.append(str);
            }

            //업로드하는 최종 영상들의 url들을 저장
            function pushVideoURLs() {
                console.log("final onclick");
                document.getElementById('videoUrls').innerHTML =
                        '<input name="videoUrls" value='+urls+' style="display: none">';
            }

            function uploadVideos() {
                let formData = new FormData();
                let inputFile = $("input[type='file']");
                let files = inputFile[0].files;
    
                for (let i = 0; i < files.length; i++) {
                    console.log(files[i]);
                    formData.append("uploadFiles", files[i]);
                }
    
                //실제 업로드 부분
                //upload ajax
                $.ajax({
                    url: '/uploadAjax',
                    processData: false,
                    contentType: false,
                    data: formData,
                    type: 'POST',
                    dataType: 'json',
                    success: function (result){
                        showUploadedVideos(result);
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.log(textStatus);
                    }
                });
            }

            $('.uploadResult').on("click", ".removeBtn", function (e) {
                let target = $(this);
                let fileName = target.data("name");
                let targetDiv = $(this).closest("div");
    
                console.log(fileName);
    
                $.post('/removeFile', {fileName: fileName}, function (result) {
                    console.log(result);
                    if (result == true) {
                        targetDiv.remove();
                        //배열에서 해당 파일이름 제거
                        urls.splice(urls.indexOf(fileName), 1);
                    }
                });
            });
        </script>
        
    </th:block>
</th:block>